# 一、什么是循环依赖

循环依赖是指多个模块、类或者组件之间相互依赖，形成一个闭环，类似于死锁。

简单来说就是A模块依赖B模块，而B模块又依赖A模块。导致spring容器无法确定加载或初始化顺序。

还有一些情况，比如多个线程之间相互占用资源等待形成死锁；JVM中使用引用计数法进行垃圾回收时，也可能会导致循环引用出现内存泄漏

# 二、Spring如何解决循环依赖

Spring中使用 **三级缓存** 解决循环依赖，这个策略的关键在于 **提前暴露未完全创建完毕的Bean**

- 一级缓存（SingletonObject）

  存储完全初始化完成的Bean，也称单例池

- 二级缓存（EarlySingletonObject）

  存储未完全初始化，但已经实例化的Bean，提前暴露对象，避免循环依赖问题。

- 三级缓存（SingletonFactory）

  一个工厂，存放获取Bean的Bean工厂，lambda表达式（会根据是否被AOP返回代理与否）

- Creating Set

  用来标志谁正在创建的过程中

  当需要依赖注入的Bean在这个集合中时，就意味着出现了循环依赖

解决步骤：

1. Spring首先创建Bean实例，将其工厂放入到三级缓存中
2. 当一个Bean依赖另一个未初始化的Bean时，Spring会从三级缓存中获取Bean的工厂，生成该Bean的代理对象
3. 代理对象放入二级缓存，解决循环依赖
4. 一旦所有依赖Bean都被完全初始化，将Bean转移到一级缓存中

